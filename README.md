# simple-custom-dg-lab-server

## 简述

一个基于[FastAPI](https://fastapi.tiangolo.com/)和[Uvicorn](https://www.uvicorn.org/)构建的简易[DG-LAB](https://github.com/DG-LAB-OPENSOURCE/DG-LAB-OPENSOURCE)消息转发服务。

主要为方便个人制作游戏Mod自用，尽可能简易~~简陋~~，预期仅支持Windows系统下使用，内含简单的Unity客户端脚本示例。

内置一个临时客户端通过WebSocket绑定DG-LAB APP，支持通过Http Post通知APP。同时支持第三方客户端连接WebSocket并与APP绑定进行通信。此处仅设计支持每组设备一一绑定，如有额外需求可自行编写代码实现。

## 功能支持

- 通道波形发送（DG-LAB 官方波形数据格式）
- DG-LAB APP导出波形字符串发送（导出波形字符串解析）
- 通道强度修改
- Http Post请求控制APP
- WebSocket连接控制APP

## 快速上手

1、此处下载 [最新版本Release](https://github.com/Kruziikloksu/simple-custom-dg-lab-server/releases/latest) ，或拉取本项目工程。如选择自行部署此处默认用户有简单的Python基础。

部署流程：

1. 拉取主分支或下载代码文件，此处不再赘述
2. 确保已安装Python，版本需求Python >= 3.11
3. 创建虚拟环境， 执行 `pip install -r requirements.txt` 安装依赖

2、运行simple-custom-dg-lab-server.exe，如果是自行部署则运行 `src/main.py`。此时将在exe文件同级目录或工程 src 目录下生成配置文件 `config.toml`，内为杂项配置，一般不需要修改。

如未修改过 `config.toml`，将默认在本地 `0.0.0.0:4503`运行用作消息转发的服务进程，同时运行内置客户端进程连接 WebSocket 并弹出二维码图片。如此处希望不希望启动内置客户端进程，可在 `config.toml`修改 `RUN_TEMP_CLIENT`值为 false后重新运行。

默认所有非DG-LAB APP （下称APP）的客户端连接时自动弹出二维码图片用于APP绑定，扫码时请保证启动APP的手机与本机处于统一网络环境下。此二维码图片如有需要请自行留存，客户端断开连接后即失效。

下方介绍使用Http Post请求和WebSocket连接两种方式控制APP，请按需实现自己的客户端。WebSocket客户端实现逻辑可参考本仓库的 `src/client.py`。此处也提供在Unity实现的两种客户端示例，可在Release下载.unitypackage文件导入工程或查阅本仓库的example目录。如果你使用[BepInEx](https://github.com/BepInEx/BepInEx)编写插件，可以参考 `example\DungeonLabExample\Network\Http\DungeonLabHttpManager.cs`的实现逻辑~~或者不嫌代码丑也可以直接拿去用~~。

### Http Post 请求

如扫描绑定内置客户端自动连接时生成的二维码，可使用Http Post向 `http://服务所在IP:端口/请求路径`发送Json请求控制APP，服务所在IP一般取本机局域网IP，可调所使用的网络库或其他方式自行获取。**收到请求后服务会向所有连接的 APP 广播对应消息。本服务不保存APP返回的通道强度数据，仅发送消息告知APP执行对应行为。**

此处支持以下几种Http Post请求路径，**以下所有的请求都会在服务内部设置了 "clientId" 和 "targetId" 后向所有已连接的APP广播消息**：

1、 `/dungeon_lab_message`

消息结构同 [DG-LAB-OPENSOURCE](https://github.com/DG-LAB-OPENSOURCE/DG-LAB-OPENSOURCE/blob/main/socket/README.md) 提供的 APP 收信协议，但无需发送"clientId"和"targetId"，此消息将在服务内部设置了 "clientId" 和 "targetId" 后直接转发给当前连接的所有DG-LAB APP 。下为Json参数：

| 参数名  | 类型   | 描述                                                        |
| :------ | :----- | :---------------------------------------------------------- |
| type    | string | 消息类型，heartbeat，bind，msg，break，error，custom        |
| message | string | 消息内容，为 APP 收信协议同名字段值，各消息类型下有不同格式 |

2、 `/dungeon_lab_strength_message`

设置指定的通道强度。下为Json参数：

| 参数名  | 类型   | 描述                                          |
| :------ | :----- | :-------------------------------------------- |
| channel | int    | 通道，1代表A，2代表B                          |
| mode    | string | 强度修改方式，0代表降低，1代表增加，2代表设置 |
| value   | int    | 通道强度修改的参数                            |

3、 `/dungeon_lab_clear_message`

清除指定的通道当前波形。下为Json参数：

| 参数名  | 类型 | 描述                 |
| :------ | :--- | :------------------- |
| channel | int  | 通道，1代表A，2代表B |

4、 `/dungeon_lab_pulse_message`

向指定通道发送波形数据。下为Json参数：

| 参数名  | 类型   | 描述                                                                                                                                                                                                                                                                                                                                                                                                            |
| :------ | :----- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| channel | int    | 通道，1代表A，2代表B                                                                                                                                                                                                                                                                                                                                                                                            |
| pulse   | string | APP波形数据值字符串，形如'["0A0A0A0A00000000","0A0A0A0A0A0A0A0A","0A0A0A0A14141414","0A0A0A0A1E1E1E1E","0A0A0A0A28282828","0A0A0A0A32323232","0A0A0A0A3C3C3C3C","0A0A0A0A46464646","0A0A0A0A50505050","0A0A0A0A5A5A5A5A","0A0A0A0A64646464"]'<br />其中每个元素的前四位表示频率，后四位表示强度，可按照[官方文档](https://github.com/DG-LAB-OPENSOURCE/DG-LAB-OPENSOURCE/blob/main/coyote/v3/README_V3.md)自行构建 |

5、 `/dungeon_lab_preset_pulse_message`

向指定通道发送 APP 导出的波形数据。下为Json参数：

| 参数名  | 类型   | 描述                                                                                                                                                                                                                                                                               |
| ------- | ------ | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| channel | int    | 通道，1代表A，2代表B                                                                                                                                                                                                                                                               |
| preset  | string | APP导出的波形字符串，形如"Dungeonlab+pulse:5,1,8=0,20,35,3,1/0.00-1,25.00-0,50.00-0,75.00-0,100.00-1,100.00-1,100.00-1,0.00-1,0.00-0,0.00-1+section+0,20,21,1,1/0.00-1,100.00-1"<br />具体解析见下文，相比自己构建波形数据，除非有特殊定制波形或数据转换的需求，个人更推荐使用这种 |

### WebSocket连接

如希望使用自定义的WebSocket客户端（下称自定义客户端）与APP进行绑定，可在启动服务后连接 `ws://服务所在IP:端口`，服务所在IP一般取本机局域网IP，可调所使用的网络库或其他方式自行获取。连接后将往客户端发送和 APP 绑定ID消息结构一致的绑定消息Json，请保存自身的唯一ID。此时二维码将自动弹出，扫码后 APP 将绑定自身唯一ID及自定义客户端唯一ID，同时发送包含clientId和targetId的绑定消息。

连接期间，每隔默认30秒（可在 `config.toml`配置）向所有客户端发送一次同APP心跳消息结构的心跳消息，绑定的双方客户端任一方断开连接将向另一方发送同APP断开连接消息结构的断连消息。**注意：任一客户端发送的所有非"custom"类型的消息将直接转发给互相绑定的另一方客户端，即自定义客户端发送的消息将转发给APP，APP发送的消息将转发给自定义客户端，**双方均使用[DG-LAB-OPENSOURCE](https://github.com/DG-LAB-OPENSOURCE/DG-LAB-OPENSOURCE/blob/main/socket/README.md) 提供的APP收信协议结构（因此也能够获取到APP返回的当前通道强度信息，请自行解析描述通道强度的字符串）**，Json结构如下：**

| 参数名   | 类型   | 描述                                                        |
| :------- | :----- | :---------------------------------------------------------- |
| type     | string | 消息类型，有heartbeat、bind、msg、break、error              |
| clientId | string | 自定义客户端的唯一ID                                        |
| targetId | string | APP的唯一ID                                                 |
| message  | string | 消息内容，为 APP 收信协议同名字段值，各消息类型下有不同格式 |

**唯一的区别是新增了"custom"类型消息用于处理自定义行为，当前有且仅有发送APP导出的波形数据**，message格式为：`preset-通道名:APP导出的波形字符串`，形如"preset-A:Dungeonlab+pulse:5,1,8=0,20,35,3,1/0.00-1,25.00-0,50.00-0,75.00-0,100.00-1,100.00-1,100.00-1,0.00-1,0.00-0,0.00-1+section+0,20,21,1,1/0.00-1,100.00-1"，具体解析见下文。相比自己构建波形数据，除非有特殊定制波形或数据转换的需求，个人更推荐使用这种，APP内更加方便编辑和体验波形，效果更好效率也更高。

此处也附上几种较常用的官方文档提供的消息格式：

1、发送波形数据

| type | message格式                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| :--- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| msg  | pulse-通道名:波形数据字符串<br />通道名为A或B<br />APP波形数据值字符串，形如'["0A0A0A0A00000000","0A0A0A0A0A0A0A0A","0A0A0A0A14141414","0A0A0A0A1E1E1E1E","0A0A0A0A28282828","0A0A0A0A32323232","0A0A0A0A3C3C3C3C","0A0A0A0A46464646","0A0A0A0A50505050","0A0A0A0A5A5A5A5A","0A0A0A0A64646464"]'<br />其中每个元素的前四位表示频率，后四位表示强度，可按照[官方文档](https://github.com/DG-LAB-OPENSOURCE/DG-LAB-OPENSOURCE/blob/main/coyote/v3/README_V3.md)自行构建 |

2、清除通道波形

| type | message格式                              |
| :--- | :--------------------------------------- |
| msg  | clear-通道值<br />通道值为0或1，对应A或B |

3、修改通道强度

| type | message格式                                                                                                                      |
| :--- | :------------------------------------------------------------------------------------------------------------------------------- |
| msg  | strength-通道值+修改方式+修改参数<br />通道值为0或1，对应A或B<br />修改方式为0或1或2，对应降低或增加或设置<br />修改参数为整形值 |

4、中断连接，一般不需要自行发送，但需要自行处理收到的情况，本服务会在绑定的双方客户端任意一方断开时向另一方发送此消息

| type  | message           | clientId             | targetId    |
| :---- | :---------------- | :------------------- | :---------- |
| break | 本服务将发送"209" | 自定义客户端的唯一ID | APP的唯一ID |

5、通道强度信息，仅在APP的通道强度改变时自动发送，可自行解析字符串获取APP当前的通道强度数据

| type | message                                                  | clientId             | targetId    |
| :--- | :------------------------------------------------------- | :------------------- | :---------- |
| msg  | strength-通道A强度+通道B强度+通道A强度上限+通道B强度上限 | 自定义客户端的唯一ID | APP的唯一ID |

## APP导出波形数据解析

DG-APP推出了波形文件导出的功能，因此我们可以比较方便地利用它在APP编辑好预设的波形小节然后导出使用。但是找了半天不知道为什么完全没找到有人做这个文件内容的解析，于是只好自己对着字符串硬~~电~~测了一晚上。

获取波形数据的方式：APP内长按波形，导出.pulse文件至本地，然后随便使用一个文本编辑器打开即可获得。

下为官方的预设波形导出的数据：

```python
{
    "呼吸": r'Dungeonlab+pulse:35,1,8=0,20,0,1,1/0.00-1,20.00-0,40.00-0,60.00-0,80.00-0,100.00-1,100.00-1,100.00-1',
    "潮汐": r'Dungeonlab+pulse:5,1,8=0,32,19,2,1/0.00-1,16.65-0,33.30-0,50.00-0,66.65-0,83.30-0,100.00-1,92.00-0,84.00-0,76.00-0,68.00-1',
    "连击": r'Dungeonlab+pulse:0,1,8=0,34,19,1,1/100.00-1,0.00-1,100.00-1,66.65-0,33.30-0,0.00-1,0.00-0,0.00-1',
    "快速按捏": r'Dungeonlab+pulse:5,1,8=0,20,19,1,1/0.00-1,28.55-1,0.00-1,52.50-1,0.00-1,73.40-1,0.00-1,87.25-1,0.00-1,100.00-1,0.00-1',
    "按捏渐强": r'Dungeonlab+pulse:5,1,8=0,20,19,1,1/0.00-1,28.55-1,0.00-1,52.50-1,0.00-1,73.40-1,0.00-1,87.25-1,0.00-1,100.00-1,0.00-1',
    "心跳节奏": r'Dungeonlab+pulse:5,1,16=65,20,5,1,1/100.00-1,100.00-1+section+0,20,19,1,1/0.00-1,0.00-0,0.00-0,0.00-0,0.00-1,75.00-1,83.30-0,91.65-0,100.00-1,0.00-1,0.00-0,0.00-0,0.00-0,0.00-1',
    "压缩": r'Dungeonlab+pulse:0,1,16=52,16,0,2,1/100.00-1,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-1+section+0,20,0,1,1/100.00-1,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-0,100.00-1',
    "节奏步伐": r'Dungeonlab+pulse:5,1,8=0,20,19,1,1/0.00-1,20.00-0,40.00-0,60.00-0,80.00-0,100.00-1,0.00-1,25.00-0,50.00-0,75.00-0,100.00-1,0.00-1,33.30-0,66.65-0,100.00-1,0.00-1,50.00-0,100.00-1,0.00-1,100.00-1,0.00-1,100.00-1,0.00-1,100.00-1,0.00-1,100.00-1',
    "颗粒摩擦": r'Dungeonlab+pulse:0,1,8=0,38,24,2,1/100.00-1,100.00-0,100.00-1,0.00-1',
    "渐变弹跳": r'Dungeonlab+pulse:20,1,16=0,30,44,2,1/0.00-1,33.30-0,66.65-0,100.00-1',
    "波浪涟漪": r'Dungeonlab+pulse:5,1,16=0,60,51,4,1/0.00-1,50.00-0,100.00-1,73.35-1',
    "雨水冲刷": r'Dungeonlab+pulse:25,1,8=4,0,38,1,1/33.50-1,66.75-0,100.00-1+section+44,54,34,1,1/100.00-1,100.00-1',
    "变速敲击": r'Dungeonlab+pulse:15,1,8=14,20,40,1,1/100.00-1,100.00-0,100.00-1,0.00-1,0.00-0,0.00-0,0.00-1+section+65,20,39,1,1/100.00-1,100.00-0,100.00-0,100.00-1',
    "信号灯": r'Dungeonlab+pulse:0,1,8=78,64,19,1,1/100.00-1,100.00-0,100.00-0,100.00-1+section+0,20,19,3,1/0.00-1,33.30-0,66.65-0,100.00-1',
    "挑逗1": r'Dungeonlab+pulse:5,1,8=0,20,35,3,1/0.00-1,25.00-0,50.00-0,75.00-0,100.00-1,100.00-1,100.00-1,0.00-1,0.00-0,0.00-1+section+0,20,21,1,1/0.00-1,100.00-1',
    "挑逗2": r'Dungeonlab+pulse:18,1,8=27,7,32,3,1/0.00-1,11.10-0,22.20-0,33.30-0,44.40-0,55.50-0,66.60-0,77.70-0,88.80-0,100.00-1+section+0,20,39,2,1/0.00-1,100.00-1',
}
```

每一条都可以看作是一个小节组，和APP界面对应，大部分内容其实很明显了："Dungeonlab+pulse"是前缀，"+section+"分割不同小节，中间的数字都是小节设置和脉冲数据。

以"呼吸": r'Dungeonlab+pulse:35,1,8=0,20,0,1,1/0.00-1,20.00-0,40.00-0,60.00-0,80.00-0,100.00-1,100.00-1,100.00-1'为例：

35是休息时长的滑条值，1是播放速率，8目前没发现是什么，但不影响构建波形。

=后这五个值为小节配置，0为渐变起始频率的滑条值，20为渐变终点频率的滑条值，0为小节时长的滑条值，第一个1为频率渐变类型，第二个1为小节是否启用。

/后的每一组值表示脉冲的强度-锚点，这里我们只需要强度值就够了。

**以上的所有值，注意是滑条值的部分，它们不是真实数据，而是APP内滑动条的值，而这些条在不同区间的步长是不一样的，需要自行对照换算才能得到实际值。**

很明显，有了这些信息，我们可以使用这份字符串构建APP收信协议的脉冲数据，插入脉冲数据的数量可以根据小节时长、播放速率、休息时长（这个有点问题，APP的显示也疑似有Bug，可以忽略不计）算出，频率则可以根据频率的起始值和终点值按照渐变类型插值算出。这样就可以基本模拟出APP导出波形的效果了。此处可参考 `src/utils.py`和 `src/pulse_section.py`，里面是我快速处理的简易解析和转换~~超长临时~~代码。
